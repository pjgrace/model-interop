<?xml version="1.0"?>
<pattern xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation ="Pattern.xsd">
	<patterndata>
		<data>
			<name>key</name>
			<value>none</value>
		</data>
		<data>
			<name>sensorid</name>
			<value>"http://api.smartsantander.eu#urn:x-iot:smartsantander:u7jcfa:t72.temperature-ambient.sensor"</value>
		</data>
	</patterndata>
	<architecture>		
		<component>
			<id>OpenAM</id>
			<address>platform.fiesta-iot.eu</address>
				<interface>
					<id>Auth</id>
					<url>https://platform.fiesta-iot.eu:443/openam</url>
					<protocol>http</protocol>
				</interface>
		</component>		
		<component>
			<id>tps</id>
			<address>certificate.fiesta-iot.eu</address>
				<interface>
					<id>tps1</id>
					<url>https://platform-dev.fiesta-iot.eu:443/tps/tps</url>
					<protocol>http</protocol>
				</interface>
		</component>		
		<component>
			<id>validator</id>
			<address>platform.fiesta-iot.eu</address>
				<interface>
					<id>onto</id>
					<url>https://platform.fiesta-iot.eu:443/ontologyValidator</url>
					<protocol>http</protocol>
				</interface>
		</component>
	</architecture>
	<behaviour>		
		<state>
			<label>Login_to_OpenAM</label>
			<type>triggerstart</type>
			<transition>
				<to>Check_login_success</to>
				<message>
					<url>component.OpenAM.Auth</url>
					<path>/json/authenticate</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>X-OpenAM-Username</name>
							<value>interop</value>
						</header>
						<header>
							<name>X-OpenAM-Password</name>
							<value>interoptest</value>
						</header>
					</headers>
					<body></body>
				</message>
			</transition>
		</state>		
		<state>
			<label>Check_login_success</label>
			<type>normal</type>
			<transition>
				<to>Call_GetLastObservations_on_TPS</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Login_to_OpenAM_failed</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>401</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>Login_to_OpenAM_failed</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "HTTP method", "value" : "/openam/json/authenticate fails with invalid credentials"}</report>
		</state>		
		<state>
			<label>Call_GetLastObservations_on_TPS</label>
			<type>trigger</type>
			<transition>
				<to>Check_GetLastObservations_Response</to>
				<message>
					<url>component.tps.tps1</url>
					<path>/getLastObservations</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
						<header>
							<name>Authorization</name>
							<value>$$patterndata.key$$</value>
						</header>
					</headers>
					<body>{"sensorIDs": [$$patterndata.sensorid$$]}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>Check_GetLastObservations_Response</label>
			<type>normal</type>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.Content-Type</param>
						<value>application/ld+json</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Incorrect_response_from_TPS</to>
				<guards>
					<notequal>
						<param>http.code</param>
						<value>200</value>
					</notequal>
				</guards>
			</transition>
			<transition>
				<to>Incorrect_headers_response_tps</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/n-quads</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/n-triples</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/n3</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/rdf+json</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/rdf+thrift</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/rdf+xml</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/trig</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/trix</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/trix+xml</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/turtle</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/x-trig</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>application/x-turtle</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>null/rdf</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/csv</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/n-quads</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/n3</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/nquads</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/plain</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/rdf+n3</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/trig</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Call_validate_observation_with_ontogy_</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.content-type</param>
						<value>text/turtle</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>Valid_TPS</label>
			<type>end</type>
			<success>true</success>
			<report>{"type" : "Compliance", "value" : "GetLastObservation implementation fully complies with FIESTA-IoT TPS specification"}</report>
		</state>		
		<state>
			<label>A13</label>
			<type>normal</type>
			<transition>
				<to>Invalid_Observation</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>Content[$.validated]</param>
						<value>false</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Valid_TPS</to>
				<guards>
					<equal>
						<param>Content[$.validated]</param>
						<value>true</value>
					</equal>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>Ontology_service_error</to>
				<guards>
					<notequal>
						<param>Content[$.validated]</param>
						<value>200</value>
					</notequal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>Invalid_Observation</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "Compliance", "value" : "Observation data is not returned in valid FIESTA-IoT format"}</report>
		</state>		
		<state>
			<label>Incorrect_response_from_TPS</label>
			<type>end</type>
			<success>false</success>
			<report>The HTTP response from GetLastObservations test invocation is incorrect. Check that the response returns a HTTP OK response, with a text body holding the observation(s).</report>
		</state>		
		<state>
			<label>Call_validate_observation_with_ontogy_</label>
			<type>trigger</type>
			<transition>
				<to>A13</to>
				<message>
					<url>component.validator.onto</url>
					<path>/Observations</path>
					<method>POST</method>
					<type>OTHER</type>
					<headers>
						<header>
							<name>iPlanetDirectoryPro</name>
							<value>$$Check_login_success|content|tokenId$$</value>
						</header>
						<header>
							<name>Accept</name>
							<value>application/json</value>
						</header>
						<header>
							<name>Content-type</name>
							<value>$$Check_GetLastObservations_Response|headers|http.content-type$$</value>
						</header>
					</headers>
					<body>$$Check_GetLastObservations_Response|content|*$$</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>Ontology_service_error</label>
			<type>end</type>
			<success>false</success>
			<report>The Ontology validation service failed due the the observation request sent. Please check the content-type and text value of the observation.</report>
		</state>		
		<state>
			<label>Incorrect_headers_response_tps</label>
			<type>end</type>
			<success>false</success>
			<report>The HTTP response from GetLastObservations test invocation is incorrect. Check that the response returna Content-Type header with the type of the observation.</report>
		</state>
	</behaviour>
</pattern>