<?xml version="1.0"?>
<pattern xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation ="Pattern.xsd">
	<patterndata>
		<data>
			<name>key</name>
			<value>Basic YWNhNjIyZTFkNTAxNjlkZTVkNTQyYjUzOTI5Y2MyZDU6</value>
		</data>
		<data>
			<name>sensorid</name>
			<value>"http://api.smartsantander.eu#urn:x-iot:smartsantander:u7jcfa:t72.temperature-ambient.sensor"</value>
		</data>
		<data>
			<name>sensorid2</name>
			<value> "http://api.smartsantander.eu#urn:x-iot:smartsantander:u7jcfa:t72.batteryLevel.sensor"</value>
		</data>
	</patterndata>
	<architecture>		
		<component>
			<id>OpenAM</id>
			<address>platform.fiesta-iot.eu</address>
				<interface>
					<id>Auth</id>
					<url>https://platform.fiesta-iot.eu:443/openam</url>
				</interface>
		</component>		
		<component>
			<id>tps</id>
			<address>fiesta-iot.smartsantander.eu</address>
				<interface>
					<id>tps1</id>
					<url>http://fiesta-iot.smartsantander.eu:5007/tps-smartsantander/api/dms</url>
				</interface>
		</component>		
		<component>
			<id>validator</id>
			<address>certificate.fiesta-iot.eu</address>
				<interface>
					<id>onto</id>
					<url>https://platform.fiesta-iot.eu:443/ontologyValidator</url>
				</interface>
		</component>
	</architecture>
	<behaviour>		
		<state>
			<label>A1</label>
			<type>triggerstart</type>
			<transition>
				<to>A2</to>
				<message>
					<url>component.OpenAM.Auth</url>
					<path>/json/authenticate</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>X-OpenAM-Username</name>
							<value>pjgrace</value>
						</header>
						<header>
							<name>X-OpenAM-Password</name>
							<value>giRRr51yn4JsGGk1qznP</value>
						</header>
					</headers>
					<body></body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A2</label>
			<type>normal</type>
			<transition>
				<to>A9</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>E1</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>401</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>E1</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "HTTP method", "value" : "/openam/json/authenticate fails with invalid credentials"}</report>
		</state>		
		<state>
			<label>A9</label>
			<type>trigger</type>
			<transition>
				<to>A10</to>
				<message>
					<url>component.tps.tps1</url>
					<path>/getLastObservations</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Content-Type</name>
							<value>application/json</value>
						</header>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
						<header>
							<name>Authorization</name>
							<value>$$patterndata.key$$</value>
						</header>
					</headers>
					<body>{"sensorIDs": [$$patterndata.sensorid$$]}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A10</label>
			<type>normal</type>
			<transition>
				<to>A12</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A11</label>
			<type>end</type>
			<success>true</success>
			<report>{"type" : "Compliance", "value" : "GetLastObservation implementation fully complies with FIESTA-IoT TPS specification"}</report>
		</state>		
		<state>
			<label>A12</label>
			<type>loop</type>
			<transition>
				<to>A13</to>
				<message>
					<url>component.validator.onto</url>
					<path>/Observations</path>
					<method>POST</method>
					<type>OTHER</type>
					<headers>
						<header>
							<name>iPlanetDirectoryPro</name>
							<value>$$A2|content|tokenId$$</value>
						</header>
						<header>
							<name>http.Content-Type</name>
							<value>application/ld+json</value>
						</header>
						<header>
							<name>http.Accept</name>
							<value>application/json</value>
						</header>
					</headers>
					<body>$$A10|content|*$$</body>
				</message>
			</transition>
			<transition>
				<to>A11</to>
				<guards>
					<counter>
						<param>Index</param>
						<value>1</value>
					</counter>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A13</label>
			<type>normal</type>
			<transition>
				<to>A12</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>Content[$.validated]</param>
						<value>true</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>A15</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>Content[$.validated]</param>
						<value>false</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A15</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "Compliance", "value" : "Observation data is not returned in valid FIESTA-IoT format"}</report>
		</state>
	</behaviour>
</pattern>