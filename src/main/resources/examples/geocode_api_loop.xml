<?xml version="1.0"?>
<pattern xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation ="Pattern.xsd">
	<patterndata>
		<data>
			<name>city</name>
			<value>London</value>
		</data>
	</patterndata>
	<architecture>		
		<component>
			<id>geocode</id>
			<address>maps.googleapis.com</address>
				<interface>
					<id>rest1</id>
					<url>https://maps.googleapis.com:443/maps/api/geocode/xml</url>
					<protocol>http</protocol>
				</interface>
				<interface>
					<id>rest2</id>
					<url>https://maps.googleapis.com:443/maps/api/geocode/json</url>
					<protocol>http</protocol>
				</interface>
		</component>
	</architecture>
	<behaviour>		
		<state>
			<label>A1</label>
			<type>triggerstart</type>
			<transition>
				<to>A2</to>
				<message>
					<url>component.geocode.rest1</url>
					<path>?address=$$patterndata.city$$</path>
					<method>GET</method>
					<type>XML</type>
					<headers>
						<header>
							<name>Content-Type</name>
							<value>application/xml</value>
						</header>
					</headers>
					<body><![CDATA[]]></body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A2</label>
			<type>normal</type>
			<transition>
				<to>A3</to>
				<guards>
					<equal>
						<param>http.from</param>
						<value>component.geocode.address</value>
					</equal>
					<equal>
						<param>http.msg</param>
						<value>REPLY</value>
					</equal>
					<equal>
						<param>content[//result/place_id]</param>
						<value>ChIJdd4hrwug2EcRmSrV3Vo6llI</value>
					</equal>
					<notequal>
						<param>content[//result/address_component/long_name]</param>
						<value>London, England</value>
					</notequal>
					<greaterthan>
						<param>content[//geometry/bounds/southwest/lat]</param>
						<value>0</value>
					</greaterthan>
					<lessthan>
						<param>content[//geometry/bounds/southwest/lng]</param>
						<value>0</value>
					</lessthan>
					<contains>
						<param>http</param>
						<value>http.code</value>
					</contains>
					<contains>
						<param>content[//geometry]</param>
						<value>viewport</value>
					</contains>
					<lessthan>
						<param>response-time</param>
						<value>2000</value>
					</lessthan>
					<regex>
						<param>http.code</param>
						<value>[0-9]+</value>
					</regex>
					<regex>
						<param>content[//result/place_id]</param>
						<value>[A-Za-z0-9]+</value>
					</regex>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A3</label>
			<type>trigger</type>
			<transition>
				<to>A4</to>
				<message>
					<url>component.geocode.rest2</url>
					<path>?address=Southampton</path>
					<method>GET</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Content-Type</name>
							<value>application/json</value>
						</header>
					</headers>
					<body></body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A4</label>
			<type>loop</type>
			<transition>
				<to>A5</to>
				<message>
					<url>component.geocode.rest2</url>
					<path>?address=Southampton</path>
					<method>GET</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Content-Type</name>
							<value>application/json</value>
						</header>
					</headers>
					<body></body>
				</message>
			</transition>
			<transition>
				<to>A6</to>
				<guards>
					<counter>
						<param>index</param>
						<value>2</value>
					</counter>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A5</label>
			<type>normal</type>
			<transition>
				<to>A4</to>
				<guards>
					<equal>
						<param>http.from</param>
						<value>component.geocode.address</value>
					</equal>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>content[$.results[0].place_id]</param>
						<value>ChIJCSkVvleJc0gR8HHaTGpajKc</value>
					</equal>
					<greaterthan>
						<param>content[$.results[0].geometry.bounds.northeast.lat]</param>
						<value>0</value>
					</greaterthan>
					<lessthan>
						<param>content[$.results[0].geometry.bounds.northeast.lng]</param>
						<value>0</value>
					</lessthan>
					<contains>
						<param>content[$.results[0]]</param>
						<value>formatted_ADDRESS</value>
					</contains>
					<contains>
						<param>http</param>
						<value>http.code</value>
					</contains>
					<notequal>
						<param>http.content-type</param>
						<value>$$A2|headers|http.content-type$$</value>
					</notequal>
					<lessthan>
						<param>response-time</param>
						<value>2000</value>
					</lessthan>
					<regex>
						<param>content[$.results[0].place_id]</param>
						<value>[A-Za-z0-9]*</value>
					</regex>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A6</label>
			<type>end</type>
			<success>true</success>
			<report>Success</report>
		</state>
	</behaviour>
</pattern>