<?xml version="1.0"?>
<pattern xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation ="Pattern.xsd">
	<patterndata>
		<data>
			<name>key</name>
			<value>test</value>
		</data>
		<data>
			<name>sensorid</name>
			<value>"https://w3id.org/laas-iot/adream#PHV_KIMO_OND8_1_COURANT_MEShttps://w3id.org/laas-iot/adream#PHV_KIMO_OND8_1_COURANT_MES"</value>
		</data>
	</patterndata>
	<architecture>		
		<component>
			<id>OpenAM</id>
			<address>platform.fiesta-iot.eu</address>
				<interface>
					<id>Auth</id>
					<url>https://platform.fiesta-iot.eu:443/openam</url>
					<protocol>http</protocol>
				</interface>
		</component>		
		<component>
			<id>tps</id>
			<address>syndream.laas.fr</address>
				<interface>
					<id>tps1</id>
					<url>https://syndream.laas.fr:8082/fiesta/tps</url>
					<protocol>http</protocol>
				</interface>
		</component>		
		<component>
			<id>validator</id>
			<address>platform.fiesta-iot.eu</address>
				<interface>
					<id>onto</id>
					<url>https://platform.fiesta-iot.eu:443/ontologyValidator</url>
					<protocol>http</protocol>
				</interface>
		</component>		
		<component>
			<id>pushEndpoint</id>
			<address>platform-dev.fiesta-iot.eu</address>
				<interface>
					<id>endpoint</id>
					<url>https://platform-dev.fiesta-iot.eu:443/mbt/interop/models</url>
					<protocol>http</protocol>
				</interface>
		</component>
	</architecture>
	<behaviour>		
		<state>
			<label>A1</label>
			<type>triggerstart</type>
			<transition>
				<to>A2</to>
				<message>
					<url>component.OpenAM.Auth</url>
					<path>/json/authenticate</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>X-OpenAM-Username</name>
							<value>interop</value>
						</header>
						<header>
							<name>X-OpenAM-Password</name>
							<value>interoptest</value>
						</header>
					</headers>
					<body></body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A2</label>
			<type>normal</type>
			<transition>
				<to>A9</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>E1</to>
				<guards>
					<equal>
						<param>HTTP.code</param>
						<value>401</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>E1</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "HTTP method error", "value" : "/openam/json/authenticate fails with invalid credentials"}</report>
		</state>		
		<state>
			<label>A9</label>
			<type>trigger</type>
			<transition>
				<to>A10</to>
				<message>
					<url>component.tps.tps1</url>
					<path>/pushLastObservations</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Authorization</name>
							<value>$$patterndata.key$$</value>
						</header>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
					</headers>
					<body>{"sensorIDs": [$$patterndata.sensorid$$], "endpointURI": "https://platform-dev.fiesta-iot.eu/mbt/interop/models/obs/125/pushObservationsStreamProxy"}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A10</label>
			<type>normal</type>
			<transition>
				<to>A11</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.msg</param>
						<value>reply</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>end</to>
				<guards>
					<notequal>
						<param>http.code</param>
						<value>200</value>
					</notequal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A11</label>
			<type>trigger</type>
			<transition>
				<to>A12</to>
				<message>
					<url>component.pushEndpoint.endpoint</url>
					<path>/obs/125</path>
					<method>GET</method>
					<type>Other</type>
					<headers>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
					</headers>
					<body>{}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A12</label>
			<type>normal</type>
			<transition>
				<to>A14</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>http.msg</param>
						<value>reply</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>trigger</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>408</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A14</label>
			<type>trigger</type>
			<transition>
				<to>A13</to>
				<message>
					<url>component.validator.onto</url>
					<path>/Observations</path>
					<method>POST</method>
					<type>OTHER</type>
					<headers>
						<header>
							<name>iPlanetDirectoryPro</name>
							<value>$$A2|content|tokenId$$</value>
						</header>
						<header>
							<name>Content-Type</name>
							<value>application/ld+json</value>
						</header>
						<header>
							<name>Accept</name>
							<value>application/json</value>
						</header>
					</headers>
					<body>$$A12|content|*$$</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A13</label>
			<type>normal</type>
			<transition>
				<to>E3</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
					<equal>
						<param>Content[$.validated]</param>
						<value>false</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>A18</to>
				<guards>
					<equal>
						<param>Content[$.validated]</param>
						<value>true</value>
					</equal>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>E3</label>
			<type>end</type>
			<success>false</success>
			<report>{"type" : "Compliance", "value" : "Observation data is not returned in valid FIESTA-IoT format"}</report>
		</state>		
		<state>
			<label>A15</label>
			<type>end</type>
			<success>true</success>
			<report>{"type" : "Compliance", "value" : "pushLastObservation implementation complies with FIESTA-IoT TPS specification."}</report>
		</state>		
		<state>
			<label>end</label>
			<type>end</type>
			<success>false</success>
			<report>{"type": "HTTP Method error", "value": "The implementation of the pushLastObservations does not respond with HTTP 200 Reply OK. Check the content-type and media types the implementation accepts, this method should not require a specific response type."}</report>
		</state>		
		<state>
			<label>E4</label>
			<type>end</type>
			<success>true</success>
			<report>{"type": "Compliance", "value": "Partial interoperability, the testbed has not posted a last observation for the given Sensor ID. One must be posted within 90 seconds of the test call. For full compliance check ensure an observation is posted to the incoming endpoint URI"}</report>
		</state>		
		<state>
			<label>trigger</label>
			<type>trigger</type>
			<transition>
				<to>normal</to>
				<message>
					<url>component.tps.tps1</url>
					<path>/stopPushOfObservations </path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
					</headers>
					<body>{"sensorIDs": [$$patterndata.sensorid$$], "endpointURI": "https://platform-dev.fiesta-iot.eu/mbt/interop/models/obs/125/pushObservationsStreamProxy"}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>normal</label>
			<type>normal</type>
			<transition>
				<to>E4</to>
				<guards>
					<equal>
						<param>http.code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>E6</to>
				<guards>
					<notequal>
						<param>http.code</param>
						<value>200</value>
					</notequal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>A18</label>
			<type>trigger</type>
			<transition>
				<to>A19</to>
				<message>
					<url>component.tps.tps1</url>
					<path>/stopPushOfObservations</path>
					<method>POST</method>
					<type>JSON</type>
					<headers>
						<header>
							<name>Accept</name>
							<value>text/plain</value>
						</header>
					</headers>
					<body>{"sensorIDs": [$$patterndata.sensorid$$], "endpointURI": "https://platform-dev.fiesta-iot.eu/mbt/interop/models/obs/125/pushObservationsStreamProxy"}</body>
				</message>
			</transition>
		</state>		
		<state>
			<label>A19</label>
			<type>normal</type>
			<transition>
				<to>A15</to>
				<guards>
					<equal>
						<param>HTTP.Code</param>
						<value>200</value>
					</equal>
				</guards>
			</transition>
			<transition>
				<to>E7</to>
				<guards>
					<notequal>
						<param>http.code</param>
						<value>200</value>
					</notequal>
				</guards>
			</transition>
		</state>		
		<state>
			<label>E6</label>
			<type>end</type>
			<success>false</success>
			<report>stopPushObservations method not implemented according to specification</report>
		</state>		
		<state>
			<label>E7</label>
			<type>end</type>
			<success>false</success>
			<report>stopPushObservations method not implemented according to specification</report>
		</state>
	</behaviour>
</pattern>